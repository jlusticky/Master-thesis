%=========================================================================
% (c) 2014, 2015 Josef Lusticky

\chapter{Measurements}\label{chap:measurements}
The results presented in this thesis are based on the setup and basic settings described in chapter~\ref{chap:setup}.
%Further settings are described
The CentOS~7 distribution kernel version 3.10.0-123.20.1.el7.x86\_64.

\section{CentOS~7 distribution kernel 3.10}

\subsection{Measurement 1 - single IPv4 flow}
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     &  1.68\% &  0.67~Gb/s & 1~000~000 \\ %DONE 2
594    & 12.28\% &  4.91~Gb/s & 1~000~000 \\ %DONE 2
1518   & 30.76\% & 12.30~Gb/s & 1~000~000 \\ %DONE 2
AMS-IX & 15.22\% &  6.09~Gb/s & 1~000~000 \\ %DONE 2
\hline
\end{tabular}

The following partial output of the /proc/interrupts file shows the interrupt mapping:
\begin{lstlisting}
      ... CPU8  CPU9   CPU10 CPU11 CPU12  ...
178:  ...    0     0  255725     0     0  ...  enp129s0-0
179:  ...    0     0       0     0     0  ...  enp129s0-1
180:  ...    0     0       0     0     0  ...  enp129s0-2
181:  ...    0     0       0     0     0  ...  enp129s0-3
182:  ...    0     0       0     0     0  ...  enp129s0-4
183:  ...    0     0       0     0     0  ...  enp129s0-5
184:  ...    0     0       0     0     0  ...  enp129s0-6
185:  ...    0     0       0     0     0  ...  enp129s0-7

186:  ...    0     0       0     0     0  ...  enp129s0d1-0
187:  ...    0     0       0     0     0  ...  enp129s0d1-1
188:  ...    0     0       0     0     0  ...  enp129s0d1-2
189:  ...    0     0       0     0     0  ...  enp129s0d1-3
190:  ...    0     0       0     0     0  ...  enp129s0d1-4
191:  ...    0     0  313670     0     0  ...  enp129s0d1-5
192:  ...    0     0       0     0     0  ...  enp129s0d1-6
193:  ...    0     0       0     0     0  ...  enp129s0d1-7
\end{lstlisting}
All packets are assigned to a single queue, in this case the queue number 5 (the enp129s0d1 is the receiving interface).
Each corresponding smp\_affinity file shows that the Linux kernel
automatically assigned interrupts to the CPUs 10-19 and 30-39.
\begin{lstlisting}
cat /proc/irq/187/smp_affinity_list
	10-19,30-39
\end{lstlisting}
Intel Performance Counter Monitor shows that the CPUs 10-19 and 30-39 are
logical cores of the CPU in Socket 1.
The CPU in this socket is directly connected to the PCI-Express link, as shown in figure~\ref{fig:setup-supermicro-board}.

The perf utility can be used to list the functions utilising the CPU 10.
\begin{lstlisting}
perf top -C 10
	12.49%  [kernel]  [k] _raw_spin_lock
	10.28%  [kernel]  [k] fib_table_lookup
	 5.90%  [kernel]  [k] mlx4_en_xmit
	 4.37%  [kernel]  [k] __netif_receive_skb_core
	 3.76%  [kernel]  [k] mlx4_en_process_rx_cq
	 3.28%  [kernel]  [k] memcpy
	 2.35%  [kernel]  [k] ip_route_input_noref
	 2.23%  [kernel]  [k] build_skb
	 2.19%  [kernel]  [k] check_leaf.isra.7
	 2.19%  [kernel]  [k] put_compound_page
\end{lstlisting}
The kernel spends most of the time on locking.

\begin{lstlisting}
 EXEC  : instructions per nominal CPU cycle
 IPC   : instructions per CPU cycle
 FREQ  : relation to nominal CPU frequency='unhalted clock ticks'/'invariant timer ticks' (includes Intel Turbo Boost)
 AFREQ : relation to nominal CPU frequency while in active state (not in power-saving C state)='unhalted clock ticks'/'invariant timer ticks while in C0-state'  (includes Intel Turbo Boost)
 L3MISS: L3 cache misses
 L2MISS: L2 cache misses (including other core's L2 cache *hits*)
 L3HIT : L3 cache hit ratio (0.00-1.00)
 L2HIT : L2 cache hit ratio (0.00-1.00)
 L3CLK : ratio of CPU cycles lost due to L3 cache misses (0.00-1.00), in some cases could be >1.0 due to a higher memory latency
 L2CLK : ratio of CPU cycles lost due to missing L2 cache but still hitting L3 cache (0.00-1.00)
 READ  : bytes read from memory controller (in GBytes)
 WRITE : bytes written to memory controller (in GBytes)
 L3OCC : L3 occupancy (in KBytes)
 TEMP  : Temperature reading in 1 degree Celsius relative to the TjMax temperature (thermal headroom): 0 corresponds to the max temperature


 Core (SKT) | EXEC | IPC  | FREQ  | AFREQ | L3MISS | L2MISS | L3HIT | L2HIT | L3CLK | L2CLK |  L3OCC | READ | WRITE | TEMP

   0    0     0.06   0.62   0.09    1.27     651 K    894 K    0.27    0.51    0.51    0.04     1800     N/A     N/A     49
   1    0     0.00   0.35   0.00    1.20     164     3002      0.95    0.13    0.04    0.17      920     N/A     N/A     49
   2    0     0.00   0.69   0.00    1.25    5888     9411      0.37    0.49    0.37    0.05       40     N/A     N/A     51
   3    0     0.00   0.27   0.00    1.14       4      534      0.99    0.12    0.00    0.13        0     N/A     N/A     53
   4    0     0.00   0.31   0.00    1.12       4      548      0.99    0.13    0.00    0.15       80     N/A     N/A     51
   5    0     0.00   0.31   0.00    1.12      10      552      0.98    0.13    0.01    0.15      160     N/A     N/A     49
   6    0     0.00   0.29   0.00    1.12      15      558      0.97    0.14    0.02    0.14        0     N/A     N/A     53
   7    0     0.00   0.31   0.00    1.12       9      549      0.98    0.14    0.01    0.15        0     N/A     N/A     52
   8    0     0.00   0.28   0.00    1.13       5      543      0.99    0.11    0.01    0.14        0     N/A     N/A     53
   9    0     0.00   0.44   0.00    1.16      82     1217      0.93    0.13    0.04    0.14        0     N/A     N/A     54
  10    1     1.02   1.72   0.59    1.11     711 K   2545 K    0.72    0.51    0.08    0.04     6240     N/A     N/A     48
  11    1     0.00   0.24   0.00    1.21      16      562      0.97    0.12    0.01    0.12        0     N/A     N/A     49
  12    1     0.00   0.24   0.00    1.17      20      557      0.96    0.11    0.02    0.11        0     N/A     N/A     47
  13    1     0.00   0.28   0.00    1.19      57     1301      0.96    0.19    0.03    0.14       40     N/A     N/A     50
  14    1     0.00   0.28   0.00    1.12      18      541      0.97    0.13    0.02    0.13      160     N/A     N/A     51
  15    1     0.00   0.26   0.00    1.12      24      549      0.96    0.13    0.02    0.12       40     N/A     N/A     53
  16    1     0.00   0.28   0.00    1.12      30      551      0.95    0.12    0.03    0.13        0     N/A     N/A     53
  17    1     0.00   0.24   0.00    1.13      22      546      0.96    0.12    0.02    0.11        0     N/A     N/A     52
  18    1     0.00   0.26   0.00    1.14      18      547      0.97    0.10    0.02    0.12       40     N/A     N/A     51
  19    1     0.00   0.20   0.00    1.17      34      619      0.95    0.10    0.03    0.11        0     N/A     N/A     51
  20    0     0.00   0.17   0.00    1.24     172      737      0.77    0.10    0.11    0.10       40     N/A     N/A     49
  21    0     0.00   0.23   0.00    1.19       5      647      0.99    0.10    0.00    0.16       40     N/A     N/A     49
  22    0     0.00   0.24   0.00    1.20       4      430      0.99    0.21    0.00    0.09        0     N/A     N/A     51
  23    0     0.00   0.35   0.00    1.15       4      531      0.99    0.12    0.01    0.17        0     N/A     N/A     51
  24    0     0.00   0.70   0.00    1.12      34      663      0.95    0.22    0.03    0.11        0     N/A     N/A     51
  25    0     0.00   0.39   0.00    1.12       7      539      0.99    0.13    0.01    0.19        0     N/A     N/A     49
  26    0     0.00   0.36   0.00    1.12      10      553      0.98    0.11    0.01    0.18        0     N/A     N/A     53
  27    0     0.00   0.36   0.00    1.12       5      541      0.99    0.13    0.01    0.17        0     N/A     N/A     52
  28    0     0.00   0.35   0.00    1.13       9      551      0.98    0.12    0.01    0.17        0     N/A     N/A     52
  29    0     0.00   0.29   0.00    1.15      39      702      0.94    0.10    0.04    0.14        0     N/A     N/A     54
  30    1     0.00   0.01   0.00    0.74     196     5329      0.96    0.03    0.01    0.07        0     N/A     N/A     47
  31    1     0.00   0.24   0.00    1.24      18      558      0.97    0.13    0.02    0.13       40     N/A     N/A     48
  32    1     0.00   0.29   0.00    1.18      17      557      0.97    0.12    0.02    0.14        0     N/A     N/A     48
  33    1     0.00   0.25   0.00    1.15      17      561      0.97    0.12    0.02    0.12       40     N/A     N/A     49
  34    1     0.00   0.34   0.00    1.12      23      541      0.96    0.12    0.03    0.15        0     N/A     N/A     51
  35    1     0.00   0.31   0.00    1.12      16      533      0.97    0.14    0.02    0.14      160     N/A     N/A     53
  36    1     0.00   0.31   0.00    1.12      18      541      0.97    0.13    0.02    0.14        0     N/A     N/A     53
  37    1     0.00   0.31   0.00    1.13      24      546      0.96    0.11    0.03    0.14        0     N/A     N/A     51
  38    1     0.00   0.27   0.00    1.14      14      554      0.97    0.11    0.01    0.13        0     N/A     N/A     50
  39    1     0.00   0.88   0.00    1.23    5320     7266      0.27    0.56    0.30    0.02       80     N/A     N/A     51
-----------------------------------------------------------------------------------------------------------------------------
 SKT    0     0.00   0.62   0.00    1.27     657 K    917 K    0.28    0.51    0.50    0.04      3080    0.02    0.00     46
 SKT    1     0.05   1.71   0.03    1.10     716 K   2567 K    0.72    0.51    0.08    0.04      6840    0.21    0.17     44
-----------------------------------------------------------------------------------------------------------------------------
 TOTAL  *     0.03   1.57   0.02    1.12    1374 K   3484 K    0.61    0.51    0.14    0.04     N/A     0.23    0.18     N/A
\end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Measurement 2 - 32 independent IPv4 flows}
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     &  1.26\% &  0.50~Gb/s & 750~000 \\ %DONE 2
594    & 12.28\% &  4.91~Gb/s & 800~000 \\ %DONE 2
1518   & 24.61\% &  9.84~Gb/s & 800~000 \\ %DONE 2
AMS-IX & 15.22\% &  6.09~Gb/s & 800~000 \\ %DONE 2
\hline
\end{tabular}

Interrupt mapping:
\begin{lstlisting}
      ...   CPU8  CPU9  CPU10 CPU11 CPU12  ...
178:  ...  94470     0      0     0     0  ...  enp129s0-0
179:  ...      0     0      0     0     0  ...  enp129s0-1
179:  ...      0     0      0     0     0  ...  enp129s0-2
179:  ...      0     0      0     0     0  ...  enp129s0-3
179:  ...      0     0      0     0     0  ...  enp129s0-4
179:  ...      0     0      0     0     0  ...  enp129s0-5
179:  ...      0     0      0     0     0  ...  enp129s0-6
179:  ...      0     0      0     0     0  ...  enp129s0-7

179:  ...  65732     0      0     0     0  ...  enp129s0d1-0
179:  ...  65764     0      0     0     0  ...  enp129s0d1-1
179:  ...  65255     0      0     0     0  ...  enp129s0d1-2
179:  ...  65381     0      0     0     0  ...  enp129s0d1-3
179:  ...  65408     0      0     0     0  ...  enp129s0d1-4
179:  ...  65253     0      0     0     0  ...  enp129s0d1-5
179:  ...  65719     0      0     0     0  ...  enp129s0d1-6
179:  ...  65796     0      0     0     0  ...  enp129s0d1-7
\end{lstlisting}
The packets are evenly distributed among all hardware queues.
However, the interrupts are not distributed among CPUs.

The output from the perf utility is show bellow.
Again, the kernel spends most of the time on locking.
\begin{lstlisting}
12.42%  [kernel]  [k] _raw_spin_lock
 6.67%  [kernel]  [k] fib_table_lookup
 6.56%  [kernel]  [k] irq_entries_start
 6.09%  [kernel]  [k] mlx4_eq_int
 4.62%  [kernel]  [k] memcpy
 4.37%  [kernel]  [k] eq_set_ci.isra.14
 4.36%  [kernel]  [k] add_interrupt_randomness
 4.01%  [kernel]  [k] mlx4_en_process_rx_cq
 3.17%  [kernel]  [k] mlx4_en_xmit
 2.76%  [kernel]  [k] __netif_receive_skb_core
\end{lstlisting}



\subsection{Over QPI}
7~000~000
\begin{lstlisting}
%for i in `seq 178 193` ; do echo 9 > /proc/irq/$i/smp_affinity_list ;done
\end{lstlisting}

\begin{lstlisting}
Core (SKT) | EXEC | IPC  | FREQ  | AFREQ | L3MISS | L2MISS | L3HIT | L2HIT | L3CLK | L2CLK |  L3OCC | READ | WRITE | TEMP

   0    0     0.00   0.51   0.00    1.07    6209       24 K    0.75    0.32    0.19    0.12      480     N/A     N/A     50
   1    0     0.00   0.28   0.00    0.94      13      546      0.98    0.12    0.01    0.14      640     N/A     N/A     50
   2    0     0.00   0.30   0.00    1.14     154     4746      0.97    0.16    0.03    0.18       40     N/A     N/A     53
   3    0     0.00   0.68   0.00    0.77      16     1452      0.99    0.14    0.01    0.15        0     N/A     N/A     53
   4    0     0.00   0.16   0.01    1.25      68     1164      0.94    0.25    0.00    0.00       80     N/A     N/A     52
   5    0     0.00   0.29   0.00    1.12      10      537      0.98    0.13    0.01    0.14      160     N/A     N/A     49
   6    0     0.00   0.28   0.00    1.13       5      538      0.99    0.13    0.01    0.14        0     N/A     N/A     55
   7    0     0.00   0.27   0.00    1.14      10      543      0.98    0.12    0.01    0.13        0     N/A     N/A     52
   8    0     0.00   0.23   0.00    1.16      10      548      0.98    0.11    0.01    0.11        0     N/A     N/A     53
   9    0     0.90   1.30   0.69    1.03    2002 K   2798 K    0.28    0.74    0.20    0.02     2360     N/A     N/A     52
  10    1     0.00   0.36   0.00    0.54     790       12 K    0.94    0.14    0.08    0.24     4640     N/A     N/A     57
  11    1     0.00   0.24   0.00    0.58      29      985      0.97    0.12    0.02    0.15        0     N/A     N/A     56
  12    1     0.00   0.18   0.00    1.03      22      569      0.96    0.11    0.02    0.09        0     N/A     N/A     55
  13    1     0.00   0.15   0.00    0.87     325     2112      0.85    0.15    0.05    0.06       40     N/A     N/A     56
  14    1     0.00   0.16   0.00    1.09     238     1328      0.82    0.16    0.05    0.05      120     N/A     N/A     60
  15    1     0.00   0.16   0.00    1.18      28      526      0.95    0.16    0.02    0.07       40     N/A     N/A     61
  16    1     0.00   0.14   0.00    1.20      32      572      0.94    0.13    0.02    0.07        0     N/A     N/A     60
  17    1     0.00   0.17   0.00    1.18      27      563      0.95    0.11    0.02    0.08        0     N/A     N/A     58
  18    1     0.00   0.18   0.00    1.18      20      563      0.96    0.12    0.01    0.09       40     N/A     N/A     57
  19    1     0.00   0.18   0.00    0.85      30      606      0.95    0.11    0.02    0.09       40     N/A     N/A     57
  20    0     0.00   0.13   0.00    0.83     158     1017      0.84    0.07    0.08    0.13       40     N/A     N/A     51
  21    0     0.00   0.39   0.00    0.63      10      553      0.98    0.13    0.02    0.20        0     N/A     N/A     51
  22    0     0.00   0.20   0.00    0.77      10      739      0.99    0.10    0.01    0.16       40     N/A     N/A     53
  23    0     0.00   0.34   0.00    0.67       7      574      0.99    0.13    0.01    0.18        0     N/A     N/A     53
  24    0     0.00   0.31   0.00    1.07      10      578      0.98    0.14    0.01    0.16        0     N/A     N/A     53
  25    0     0.00   0.34   0.00    1.12       4      535      0.99    0.14    0.01    0.16        0     N/A     N/A     49
  26    0     0.00   0.34   0.00    1.12      11      551      0.98    0.12    0.01    0.16        0     N/A     N/A     56
  27    0     0.00   0.27   0.00    1.13      11      550      0.98    0.13    0.01    0.13        0     N/A     N/A     52
  28    0     0.00   0.28   0.00    1.14      10      560      0.98    0.13    0.01    0.14        0     N/A     N/A     54
  29    0     0.00   0.32   0.00    0.79      97     5729      0.98    0.07    0.00    0.05        0     N/A     N/A     52
  30    1     0.00   0.14   0.00    0.54     185      911      0.80    0.08    0.10    0.12        0     N/A     N/A     57
  31    1     0.00   0.25   0.00    0.69      19      572      0.97    0.11    0.02    0.13        0     N/A     N/A     56
  32    1     0.00   0.27   0.00    0.71      15      556      0.97    0.13    0.02    0.13       80     N/A     N/A     55
  33    1     0.00   0.22   0.00    0.73      23      591      0.96    0.13    0.02    0.12       40     N/A     N/A     55
  34    1     0.00   0.18   0.00    1.13      21      555      0.96    0.12    0.01    0.09        0     N/A     N/A     59
  35    1     0.00   0.20   0.00    1.15      21      539      0.96    0.15    0.02    0.09      120     N/A     N/A     61
  36    1     0.00   0.20   0.00    1.16      23      555      0.96    0.13    0.02    0.09        0     N/A     N/A     61
  37    1     0.00   2.00   0.00    1.22      63      684      0.91    0.18    0.01    0.02        0     N/A     N/A     58
  38    1     0.00   0.19   0.00    1.23      16      555      0.97    0.14    0.01    0.10        0     N/A     N/A     57
  39    1     0.00   0.79   0.00    1.20    4826     7108      0.32    0.52    0.24    0.02        0     N/A     N/A     57
-----------------------------------------------------------------------------------------------------------------------------
 SKT    0     0.05   1.27   0.04    1.03    2009 K   2844 K    0.29    0.73    0.20    0.02      3840    0.37    0.39     47
 SKT    1     0.00   0.54   0.00    0.91    6753       32 K    0.79    0.26    0.10    0.08      5160    0.00    0.00     52
-----------------------------------------------------------------------------------------------------------------------------
 TOTAL  *     0.02   1.27   0.02    1.03    2015 K   2877 K    0.30    0.73    0.19    0.02     N/A     0.37    0.39     N/A

 Instructions retired: 2359 M ; Active cycles: 1862 M ; Time (TSC): 2598 Mticks ; C0 (active,non-halted) core residency: 1.75 %

 C1 core residency: 3.61 %; C3 core residency: 0.00 %; C6 core residency: 94.64 %; C7 core residency: 0.00 %;
 C2 package residency: 49.46 %; C3 package residency: 0.00 %; C6 package residency: 0.00 %; C7 package residency: 0.00 %;

 PHYSICAL CORE IPC                 : 2.53 => corresponds to 63.33 % utilization for cores in active state
 Instructions per nominal CPU cycle: 0.05 => corresponds to 1.14 % core utilization over time interval

Intel(r) QPI data traffic estimation in bytes (data traffic coming to CPU/socket through QPI links):

               QPI0     QPI1    |  QPI0   QPI1  
----------------------------------------------------------------------------------------------
 SKT    0       90 M     90 M   |    0%     0%   
 SKT    1       70 M     71 M   |    0%     0%   
----------------------------------------------------------------------------------------------
Total QPI incoming data traffic:  323 M     QPI data traffic/Memory controller traffic: 0.39
\end{lstlisting}

9
 21.25%  [kernel]  [k] _raw_spin_lock
  11.61%  [kernel]  [k] memcpy
   6.69%  [kernel]  [k] fib_table_lookup
   6.60%  [kernel]  [k] skb_gro_reset_offset
   4.55%  [kernel]  [k] udp_gro_receive
   3.96%  [kernel]  [k] mlx4_en_xmit
   3.44%  [kernel]  [k] mlx4_en_process_rx_cq
   2.93%  [kernel]  [k] mlx4_en_poll_tx_cq


10
  9.77%  [kernel]  [k] find_busiest_group
   3.47%  [kernel]  [k] cpumask_next_and
   3.01%  [kernel]  [k] _raw_spin_lock
   2.93%  [kernel]  [k] ktime_get
   2.59%  [kernel]  [k] mlx4_en_DUMP_ETH_STATS
   2.58%  [kernel]  [k] run_timer_softirq
   2.36%  [kernel]  [k] idle_cpu
   2.22%  [kernel]  [k] __schedule
   


\newpage
Measurement 3 - 32 IPv4 flows with irqbalance daemon

\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     & 2.75\% & 1.12~Gb/s & 1 666 666 \\ %DONE
594    & 21\%   & 8.4~Gb/s  & 1 710 097 \\ %DONE
1518   & 52.5\% & 21~Gb/s   & 1 706 762 \\ %DONE
AMS-IX & 26\%   & 10.4~Gb/s & 1 708 826 \\ %DONE
\hline
\end{tabular}

\begin{lstlisting}[basicstyle=\tiny]
  CPU0   CPU1  CPU2   CPU3  CPU4   CPU5   CPU6   CPU7   CPU8   CPU9   CPU10  CPU11
     0      0     1      0     0      0      0      0      0      0      0      0  enp6s0-0
     0      0     0   9113     0      0      0      0      0      0      0      0  enp6s0-1
     0      0     0      0 52451  93474      0      0  24253      0      0      0  enp6s0-2
     0      0     0      0 27286 239426      0      0      0      0      0      0  enp6s0-3
 40703      0     0  27811     0      0      0      0      0      0      0      0  enp6s0-4
     0 115464     0      0     0      0      0      0      0      0      0      0  enp6s0-5
     0      0     0      0     0      0      0      0 136833      0      0      0  enp6s0-6
     0      0     0      0     0      0      0      0      0  58708      0      0  enp6s0-7

     0      0     0      0     0      0      0      0      0      0 127936      0  enp6s0d1-0
     0      0     0      0     0      0      0      0      0      0      0 127932  enp6s0d1-1
     0      0     0      0     0      0 115624  12126      0      0      0      0  enp6s0d1-2
     0      0 24926      0 37054      0      0  65657      0      0      0      0  enp6s0d1-3
     0      0 15885      0     0      0  99709      0      0  12126      0      0  enp6s0d1-4
     0      0     0 127622     0      0      0      0      0      0      0      0  enp6s0d1-5
     0      0     0      0 41024      0      0      0      0      0      0  86906  enp6s0d1-6
     0      0 12125      0     0 115808      0      0      0      0      0      0  enp6s0d1-7
\end{lstlisting}
Irqbalance moves the interrupts between CPUs.
Heavily depends on the dynamic IRQ mappings.
Executing the hardware interrupt handler on new CPU that has not served the interrupt yet causes cache miss.

%Changes TX queues using Transmit Packet Steering (XPS) - cat /sys/class/net/enp6s0/queues/tx-?/xps_cpus


%\begin{lstlisting}
%for i in `seq 99 114`; do cat /proc/irq/$i/smp_affinity ; done
%\end{lstlisting}


\newpage

Measurement 4 - 32 IPv4 flows with custom IRQ affinity mappings:
\begin{lstlisting}
echo f00 > /proc/irq/default_smp_affinity   # only for new registered irqs
for i in `seq 0 98`; do echo f00 > /proc/irq/$i/smp_affinity; done
for i in `seq 115 124`; do echo f00 > /proc/irq/$i/smp_affinity; done

echo 001 > /proc/irq/99/smp_affinity
echo 002 > /proc/irq/100/smp_affinity
echo 004 > /proc/irq/101/smp_affinity
echo 008 > /proc/irq/102/smp_affinity
echo 010 > /proc/irq/103/smp_affinity
echo 020 > /proc/irq/104/smp_affinity
echo 040 > /proc/irq/105/smp_affinity
echo 080 > /proc/irq/106/smp_affinity

echo 001 > /proc/irq/107/smp_affinity
echo 002 > /proc/irq/108/smp_affinity
echo 004 > /proc/irq/109/smp_affinity
echo 008 > /proc/irq/110/smp_affinity
echo 010 > /proc/irq/111/smp_affinity
echo 020 > /proc/irq/112/smp_affinity
echo 040 > /proc/irq/113/smp_affinity
echo 080 > /proc/irq/114/smp_affinity
\end{lstlisting}

\begin{tabular}{ | l | l | l | l |}
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
AMS-IX &  81.40\% & 32.56~Gb/s & 5~350~000 \\ %DONE 2
64     &   8.82\% &  3.53~Gb/s & 5~250~000 \\ %DONE 2
594    &  65.70\% & 26.28~Gb/s & 5~350~000 \\ %DONE 2
1518   &  99.60\% & 39.84~Gb/s & 3~237~971 \\ %DONE 2
\hline
\end{tabular}


\begin{lstlisting}
 178:          0     298717          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-0
 179:          0          0     294264          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-1
 180:          0          0          0     291502          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-2
 181:          0          0          0          0     296514          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-3
 182:          0          0          0          0          0     302588          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-4
 183:          0          0          0          0          0          0     294017          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-5
 184:          0          0          0          0          0          0          0     294314          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-6
 185:          0          0          0          0          0          0          0          0     302088          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0-7
 186:          0     402863          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-0
 187:          0          0     411668          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-1
 188:          0          0          0     416164          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-2
 189:          0          0          0          0     422023          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-3
 190:          0          0          0          0          0     421805          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-4
 191:          0          0          0          0          0          0     415759          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-5
 192:          0          0          0          0          0          0          0     402918          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-6
 193:          0          0          0          0          0          0          0          0     413299          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      enp129s0d1-7
\end{lstlisting}


\begin{lstlisting}[basicstyle=\tiny]
  CPU0   CPU1   CPU2   CPU3   CPU4   CPU5   CPU6   CPU7  CPU8   CPU9   CPU10  CPU11
 30455      0      0      0      0      0      0      0     0      0      0      0  enp6s0-0
     0  30292      0      0      0      0      0      0     0      0      0      0  enp6s0-1
     0      0  33714      0      0      0      0      0     0      0      0      0  enp6s0-2
     0      0      0  33157      0      0      0      0     0      0      0      0  enp6s0-3
     0      0      0      0  33246      0      0      0     0      0      0      0  enp6s0-4
     0      0      0      0      0  33453      0      0     0      0      0      0  enp6s0-5
     0      0      0      0      0      0  30818      0     0      0      0      0  enp6s0-6
     0      0      0      0      0      0      0  31255     0      0      0      0  enp6s0-7

235118      0      0      0      0      0      0      0     0      0      0      0  enp6s0d1-0
     0 223557      0      0      0      0      0      0     0      0      0      0  enp6s0d1-1
     0      0 297150      0      0      0      0      0     0      0      0      0  enp6s0d1-2
     0      0      0 319487      0      0      0      0     0      0      0      0  enp6s0d1-3
     0      0      0      0 297713      0      0      0     0      0      0      0  enp6s0d1-4
     0      0      0      0      0 302353      0      0     0      0      0      0  enp6s0d1-5
     0      0      0      0      0      0 224581      0     0      0      0      0  enp6s0d1-6
     0      0      0      0      0      0      0 229381     0      0      0      0  enp6s0d1-7
\end{lstlisting}





\newpage



IPv6:
ip link set down dev {\it{ifname}}

M
Single IPv6/UDP stream.
echo 0 > /proc/sys/net/ipv6/conf/all/disable\_ipv6
echo 1 > /proc/sys/net/ipv6/conf/all/forwarding
again, forwarding on only selected interfaces can be enabled.
ip6tables -F
ip6tables -X
ip6tables -L

ip -6 addr add 1::1/64 dev enp6s0d1
ip -6 addr add 2::1/64 dev enp6s0


% DONE 2
\subsection{Single IPv6 flow - targeted CPU}
%Single IPv6 flow.
%To test the difference between IPv4 and IPv6 routing lookup performance.

\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & frame rate \\
\hline
78     &  1.96\% &  0.78~Gb/s & 1~000~000 \\ %DONE 2
594    & 12.28\% &  4.91~Gb/s & 1~000~000 \\ %DONE 2
1518   & 30.76\% & 12.30~Gb/s & 1~000~000 \\ %DONE 2
AMS-IX & 15.22\% &  6.86~Gb/s & 1~000~000 \\ %DONE 2
\hline
\end{tabular}


\subsection{32 independent IPv6 flows - targeted IRQs}
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
78     &  4.90\% &  1.96~Gb/s & 2~500~000 \\ %DONE 2
594    & 31.32\% & 12.53~Gb/s & 2~550~000 \\ %DONE 2
1518   & 98.00\% & 39.20~Gb/s & 3~185~955 \\ %DONE 2
AMS-IX & 48.69\% & 19.48~Gb/s & 3~200~000 \\ %DONE 2
\hline
\end{tabular}
The scaling mechanisms are sensitive to frame size.


SPIN LOCK
  17.70%  [kernel]          [k] ip6_pol_route.isra.46
   8.18%  [kernel]          [k] _raw_spin_lock
   8.17%  [kernel]          [k] fib6_lookup
   6.43%  [kernel]          [k] _raw_read_lock_bh
   5.60%  [kernel]          [k] _raw_read_unlock_bh
   5.39%  [kernel]          [k] fib6_get_table
   4.79%  [kernel]          [k] dst_release
   3.37%  [kernel]          [k] ip6_finish_output2
   2.48%  [kernel]          [k] mlx4_en_xmit
   2.11%  [kernel]          [k] __netif_receive_skb_core
   2.08%  [kernel]          [k] memcpy
   2.04%  [kernel]          [k] mlx4_en_process_rx_cq
   1.32%  [kernel]          [k] mlx4_en_poll_tx_cq
   1.27%  [kernel]          [k] local_bh_enable_ip
   1.26%  [kernel]          [k] __pskb_pull_tail
   1.19%  [kernel]          [k] put_compound_page




%Measurement:

%Mixed environment simulating real internet traffic.


%Measurement:
%MTU 9000
%ip link set eth0 mtu 9000

%Measurement:
%Hyper-Threading disabled.


%----

%Measurement:
%Full BGP table in the memory.
%Expensive routing lookups.


%----

%Forwarded packet count:
%/proc/net/snmp
%/proc/net/snmp6
%Can be viewed by netstat -s



\section{Resource utilisation}
AMS-IX 32 IPv4/UDP flows - 47\% of the link (18.8~Gb/s)
Measured by Intel Performance Counter Monitor v2.8.
%\footnote{\url{https://software.intel.com/en-us/articles/intel-performance-counter-monitor}}

CPU usage: ./pcm.x
\begin{lstlisting}
 EXEC  : instructions per nominal CPU cycle
 IPC   : instructions per CPU cycle
 FREQ  : relation to nominal CPU frequency='unhalted clock ticks'/'invariant timer ticks' (includes Intel Turbo Boost)
 AFREQ : relation to nominal CPU frequency while in active state (not in power-saving C state)='unhalted clock ticks'/'invariant timer ticks while in C0-state'  (includes Intel Turbo Boost)
 L3MISS: L3 cache misses 
 L2MISS: L2 cache misses (including other core's L2 cache *hits*) 
 L3HIT : L3 cache hit ratio (0.00-1.00)
 L2HIT : L2 cache hit ratio (0.00-1.00)
 L3CLK : ratio of CPU cycles lost due to L3 cache misses (0.00-1.00), in some cases could be >1.0 due to a higher memory latency
 L2CLK : ratio of CPU cycles lost due to missing L2 cache but still hitting L3 cache (0.00-1.00)
 READ  : bytes read from memory controller (in GBytes)
 WRITE : bytes written to memory controller (in GBytes)
 TEMP  : Temperature reading in 1 degree Celsius relative to the TjMax temperature (thermal headroom): 0 corresponds to the max temperature


 Core (SKT) | EXEC | IPC  | FREQ  | AFREQ | L3MISS | L2MISS | L3HIT | L2HIT | L3CLK | L2CLK |  READ | WRITE | TEMP

   0    0     0.94   0.84   1.12    1.12     223 K   4335 K    0.95    0.75    0.01    0.07     N/A     N/A     44
   1    0     0.94   0.84   1.12    1.12     224 K   4229 K    0.95    0.76    0.01    0.07     N/A     N/A     44
   2    0     1.14   1.03   1.10    1.12     165 K   4154 K    0.96    0.77    0.01    0.07     N/A     N/A     40
   3    0     1.11   1.04   1.07    1.12     157 K   4049 K    0.96    0.78    0.01    0.07     N/A     N/A     42
   4    0     1.12   1.05   1.07    1.12     178 K   4160 K    0.96    0.78    0.01    0.07     N/A     N/A     45
   5    0     1.11   1.03   1.07    1.12     178 K   4331 K    0.96    0.78    0.01    0.08     N/A     N/A     42
   6    0     0.94   0.84   1.12    1.12     232 K   4396 K    0.95    0.73    0.01    0.07     N/A     N/A     43
   7    0     0.94   0.84   1.12    1.12     240 K   4302 K    0.94    0.75    0.01    0.07     N/A     N/A     45
   8    0     0.00   0.35   0.00    1.12      10 K     20 K    0.49    0.45    0.45    0.10     N/A     N/A     40
   9    0     0.00   0.33   0.00    1.12     256      521      0.51    0.27    0.41    0.11     N/A     N/A     42
  10    0     0.00   0.34   0.00    1.11    1152     1522      0.24    0.22    0.79    0.06     N/A     N/A     44
  11    0     0.00   0.50   0.00    1.12    2562     6222      0.59    0.66    0.18    0.07     N/A     N/A     42
-----------------------------------------------------------------------------------------------------------------------------
 SKT    0     0.69   0.94   0.73    1.12    1615 K     33 M    0.95    0.76    0.01    0.07    0.41    0.92     40
-----------------------------------------------------------------------------------------------------------------------------
 TOTAL  *     0.69   0.94   0.73    1.12    1615 K     33 M    0.95    0.76    0.01    0.07    0.41    0.92     N/A
\end{lstlisting}

CPU Usage: ./pcm-tsx.x
\begin{lstlisting}
Core | IPC  | Instructions | Cycles  | Transactional Cycles | Aborted Cycles  | #RTM  | #HLE  | Cycles/Transaction 
   0   0.84       2525 M     2993 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   1   0.85       2526 M     2988 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   2   1.05       2986 M     2856 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   3   1.04       2979 M     2867 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   4   1.04       3001 M     2874 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   5   1.04       2974 M     2866 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   6   0.84       2518 M     2986 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   7   0.84       2525 M     2992 M         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   8   0.32        939 K     2912 K         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
   9   0.37         38 K      104 K         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
  10   0.43        128 K      299 K         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
  11   0.42        531 K     1257 K         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
-------------------------------------------------------------------------------------------------------------------
   *   0.94         22 G       23 G         0   ( 0.00%)          0   ( 0.00%)    0        0       N/A
\end{lstlisting}


Memory Usage: ./pcm-memory.x
\begin{lstlisting}
---------------------------------------|
--             Socket 0              --|
---------------------------------------|
---------------------------------------|
---------------------------------------|
--   Memory Performance Monitoring   --|
---------------------------------------|
--  Mem Ch 0: Reads (MB/s):   97.09  --|
--            Writes(MB/s):  293.82  --|
--  Mem Ch 1: Reads (MB/s):  108.90  --|
--            Writes(MB/s):  228.77  --|
--  Mem Ch 2: Reads (MB/s):  123.57  --|
--            Writes(MB/s):  246.80  --|
--  Mem Ch 3: Reads (MB/s):   95.23  --|
--            Writes(MB/s):  207.95  --|
-- NODE0 Mem Read (MB/s):    424.79  --|
-- NODE0 Mem Write (MB/s) :  977.34  --|
-- NODE0 P. Write (T/s) :    540435  --|
-- NODE0 Memory (MB/s):  1402.13     --|
---------------------------------------||---------------------------------------
--                   System Read Throughput(MB/s):    424.79                  --
--                  System Write Throughput(MB/s):    977.34                  --
--                 System Memory Throughput(MB/s):   1402.13                  --
---------------------------------------||---------------------------------------
\end{lstlisting}

PCI-Express usage: ./pcm-pcie.x
\begin{lstlisting}
Skt | PCIeRdCur | PCIeNSRd  | PCIeWiLF | PCIeItoM | PCIeNSWr | PCIeNSWrF | PCIe Rd (B) | PCIe Wr (B)
 0        41 M         0           0         41 M        0          0          2675 M         2668 M
----------------------------------------------------------------------------------------------------------------
 *         41 M         0           0         83 M        0          0          2675 M         5336 M
\end{lstlisting}
Note, that there is a bug in Intel's PCM related to displaying
the total PCIe Write bandwidth - it always shows double the expected value.


Software functions:
\begin{lstlisting}
22.02%  [kernel]  [k] fib_table_lookup
 4.33%  [kernel]  [k] mlx4_en_xmit
 4.09%  [kernel]  [k] _raw_spin_lock
 3.23%  [kernel]  [k] check_leaf.isra.7
 3.02%  [kernel]  [k] __netif_receive_skb_core
 2.74%  [kernel]  [k] memcpy
 2.62%  [kernel]  [k] mlx4_en_process_rx_cq
 2.54%  [kernel]  [k] ip_route_input_noref
 1.91%  [kernel]  [k] dev_gro_receive
 1.87%  [kernel]  [k] build_skb
 1.87%  [kernel]  [k] ip_rcv
 1.71%  [kernel]  [k] mlx4_en_poll_tx_cq
 1.61%  [kernel]  [k] fib_validate_source
 1.38%  [kernel]  [k] nf_iterate
 1.33%  [kernel]  [k] ip_finish_output
 1.27%  [kernel]  [k] irq_entries_start
 1.14%  [kernel]  [k] mlx4_en_complete_rx_desc
 1.13%  [kernel]  [k] mlx4_en_free_tx_desc.isra.22
 1.08%  [kernel]  [k] selinux_ip_forward                    TODO
 1.08%  [kernel]  [k] put_compound_page
 1.03%  [kernel]  [k] __netdev_alloc_frag
 1.02%  [kernel]  [k] ip_forward
 1.01%  [kernel]  [k] dev_hard_start_xmit
\end{lstlisting}



SELinux disabled:
\begin{lstlisting}
 19.25%  [kernel]           [k] fib_table_lookup
  4.99%  [kernel]           [k] mlx4_en_xmit
  4.32%  [kernel]           [k] _raw_spin_lock
  4.27%  [kernel]           [k] check_leaf.isra.7
  4.22%  [kernel]           [k] ipt_do_table
  3.16%  [kernel]           [k] __netif_receive_skb_core
  2.69%  [kernel]           [k] mlx4_en_process_rx_cq
  2.51%  [kernel]           [k] memcpy
  2.42%  [kernel]           [k] ip_route_input_noref
  2.06%  [kernel]           [k] ip_rcv
  2.05%  [kernel]           [k] mlx4_en_poll_tx_cq
  2.04%  [kernel]           [k] dev_gro_receive
  1.76%  [kernel]           [k] fib_validate_source
  1.75%  [kernel]           [k] nf_iterate
  1.64%  [kernel]           [k] build_skb
  1.53%  [kernel]           [k] ip_finish_output
  1.41%  [kernel]           [k] dev_queue_xmit
  1.18%  [kernel]           [k] local_bh_enable
  1.17%  [kernel]           [k] mlx4_en_complete_rx_desc
  1.15%  [kernel]           [k] dev_hard_start_xmit
  1.13%  [kernel]           [k] ip_forward
  1.09%  [kernel]           [k] mlx4_en_free_tx_desc.isra.22
  1.07%  [kernel]           [k] __netdev_alloc_frag
\end{lstlisting}

Disabled SELinux:
IPv4 AMS-IX - 51\% , 3 351 928 fps

Disabled rp\_filter -

AMS-IX 57.5\% - 3 779 135 pps
64 - 6.35\% - 3 779 761 pps

1518 - 99.5\% - 3 234 720 pps

1518 - PCI-Express bandwidth:
\begin{lstlisting}
Skt | PCIeRdCur | PCIeNSRd  | PCIeWiLF | PCIeItoM | PCIeNSWr | PCIeNSWrF | PCIe Rd (B) | PCIe Wr (B)
 0        89 M         0           0         81 M        0          0          5752 M         5229 M
\end{lstlisting}

pcm-memory
\begin{lstlisting}
---------------------------------------|
--             Socket 0              --|
---------------------------------------|
---------------------------------------|
---------------------------------------|
--   Memory Performance Monitoring   --|
---------------------------------------|
--  Mem Ch 0: Reads (MB/s):   64.52  --|
--            Writes(MB/s):  395.85  --|
--  Mem Ch 1: Reads (MB/s):   53.51  --|
--            Writes(MB/s):  394.04  --|
--  Mem Ch 2: Reads (MB/s):   52.30  --|
--            Writes(MB/s):  393.64  --|
--  Mem Ch 3: Reads (MB/s):  148.94  --|
--            Writes(MB/s):  430.75  --|
-- NODE0 Mem Read (MB/s):    319.27  --|
-- NODE0 Mem Write (MB/s) : 1614.29  --|
-- NODE0 P. Write (T/s) :    540289  --|
-- NODE0 Memory (MB/s):  1933.56     --|
---------------------------------------||---------------------------------------
--                   System Read Throughput(MB/s):    319.27                  --
--                  System Write Throughput(MB/s):   1614.29                  --
--                 System Memory Throughput(MB/s):   1933.56                  --
---------------------------------------||---------------------------------------
\end{lstlisting}
turbostat -i 1 - 2.9~Ghz, 100.00\% in C0 state



\section{Upstream mainline kernel 3.19.2}

%DONE2
\subsection{1 IPv4 flow 3.19.2 kernel}
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     &  1.60\% &  0.64~Gb/s & 950~000 \\ %DONE 2
594    & 11.66\% &  4.66~Gb/s & 950~000 \\ %DONE 2
1518   & 29.22\% & 11.69~Gb/s & 950~000 \\ %DONE 2
AMS-IX & 14.45\% &  5.78~Gb/s & 950~000 \\ %DONE 2
\hline
\end{tabular}
%slabsi nez rhel (xx\%), ale dovoli 16 EQ
% single cpu - rhel7 kernel outperforms the mainline 3.19.2

%DONE2
\subsection{8 queues}
32 IPv4 flows on 8 queues
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     &  5.29\% &  2.12~Gb/s & 3~150~000 \\ %DONE 2
594    & 43.59\% & 17.44~Gb/s & 3~550~000 \\ %DONE 2
1518   & 99.50\% & 39.80~Gb/s & 3~234~720 \\ %DONE 2
AMS-IX & 54.77\% & 21.91~Gb/s & 3~600~000 \\ %DONE 2
\hline
\end{tabular}

\subsection{16 queues}
%ethtool --set-channels enp129s0 rx 16
32 IPv4 flows 3.19.2 kernel
%16 queues -> 5~300~000 fps

\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
64     &   6.22\% &  2.49~Gb/s & 3~600~000 \\ %DONE 2
594    &  55.26\% & 22.10~Gb/s & 4~500~000 \\ %DONE 2
1518   &  97.00\% & 38.80~Gb/s & 3~153~446 \\ %DONE 2
AMS-IX &  68.47\% & 27.39~Gb/s & 4~500~000 \\ %DONE 2
\hline
\end{tabular}


\begin{lstlisting}
 119:          0     388082          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-0
 120:          0          0     388829          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-1
 121:          0          0          0     382880          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-2
 122:          0          0          0          0     382873          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-3
 123:          0          0          0          0          0     385362          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-4
 124:          0          0          0          0          0          0     385740          0          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-5
 125:          0          0          0          0          0          0          0     392378          0          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-6
 126:          0          0          0          0          0          0          0          0     391076          0          0          0          0          0          0          0          0          0          0          0          0  enp129s0-7
 143:          0          0          0          0          0          0          0          0          0     389639          0          0          0          0          0          0          0          0          0          0          0  enp129s0-8
 144:          0          0          0          0          0          0          0          0          0          0     390158          0          0          0          0          0          0          0          0          0          0  enp129s0-9
 145:          0          0          0          0          0          0          0          0          0          0          0     387722          0          0          0          0          0          0          0          0          0  enp129s0-10
 146:          0          0          0          0          0          0          0          0          0          0          0          0     388898          0          0          0          0          0          0          0          0  enp129s0-11
 147:          0          0          0          0          0          0          0          0          0          0          0          0          0     387333          0          0          0          0          0          0          0  enp129s0-12
 148:          0          0          0          0          0          0          0          0          0          0          0          0          0          0     386539          0          0          0          0          0          0  enp129s0-13
 149:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0     385551          0          0          0          0          0  enp129s0-14
 150:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0     385944          0          0          0          0  enp129s0-15
 127:          0    3540033          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-0
 128:          0          0    3543071          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-1
 129:          0          0          0    6487887          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-2
 130:          0          0          0          0    6507641          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-3
 131:          0          0          0          0          0    5251278          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-4
 132:          0          0          0          0          0          0    4994263          0          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-5
 133:          0          0          0          0          0          0          0    3768193          0          0          0          0          0          0          0          0          0          0          0          0          0  eth1-6
 134:          0          0          0          0          0          0          0          0    3664652          0          0          0          0          0          0          0          0          0          0          0          0  eth1-7
 135:          0          0          0          0          0          0          0          0          0    6999268          0          0          0          0          0          0          0          0          0          0          0  eth1-8
 136:          0          0          0          0          0          0          0          0          0          0    7010796          0          0          0          0          0          0          0          0          0          0  eth1-9
 137:          0          0          0          0          0          0          0          0          0          0          0    3538051          0          0          0          0          0          0          0          0          0  eth1-10
 138:          0          0          0          0          0          0          0          0          0          0          0          0    3541377          0          0          0          0          0          0          0          0  eth1-11
 139:          0          0          0          0          0          0          0          0          0          0          0          0          0    3542374          0          0          0          0          0          0          0  eth1-12
 140:          0          0          0          0          0          0          0          0          0          0          0          0          0          0    3537064          0          0          0          0          0          0  eth1-13
 141:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0    5675982          0          0          0          0          0  eth1-14
 142:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0    5637519          0          0          0          0  eth1-15
\end{lstlisting}


  16.38%  [kernel]            [k] fib_table_lookup
   6.11%  [kernel]            [k] irq_entries_start
   3.83%  [kernel]            [k] _raw_spin_lock
   3.31%  [kernel]            [k] mlx4_en_xmit
   3.27%  [kernel]            [k] mlx4_eq_int
   2.96%  [kernel]            [k] mlx4_en_process_rx_cq
   2.87%  [kernel]            [k] check_leaf.isra.6
   2.31%  [kernel]            [k] eq_set_ci.isra.14
   2.06%  [kernel]            [k] memcpy
   1.67%  [kernel]            [k] ip_rcv
   1.57%  [kernel]            [k] ip_route_input_noref
   1.51%  [kernel]            [k] __netif_receive_skb_core
   1.38%  [kernel]            [k] mlx4_en_poll_tx_cq
   1.33%  [kernel]            [k] dev_gro_receive
   1.27%  [kernel]            [k] mlx4_en_complete_rx_desc
   1.22%  [kernel]            [k] build_skb
   1.05%  [kernel]            [k] __dev_queue_xmit
   1.05%  [kernel]            [k] tasklet_action
   1.05%  [kernel]            [k] mlx4_en_alloc_frags
   1.02%  [kernel]            [k] ip_forward
   1.01%  [kernel]            [k] ip_finish_output



\subsection{IPv6 32 flows - 16 queues}
\begin{tabular}{ | l | l | l | l | }
\hline
Frame size & \% of link & bandwidth & frame rate \\
\hline
78     &   \% &  ~Gb/s &  \\
594    &  48.51\% & 19.40~Gb/s & 3~950~000 \\ %DONE 2
1518   &  \% & ~Gb/s &  \\
AMS-IX &  60.86\% & 24.34~Gb/s & 4~000~000 \\ %DONE 2
\hline
\end{tabular}



%1200 netdev\_budget - -||- - no influence - raise softirq is highly optimised
%rp\_filter off - 5~325~000 fps - 81.02\% -32.4~Gbps


%[ 1113.746810] mlx4_en: enp129s0d1: Using 16 RX rings
%[ 1113.746825] mlx4_en: enp129s0d1:   frag:0 - size:1526 prefix:0 align:0 stride:1536
%[ 1113.749856] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-8 ,Falling back to legacy EQ's
%[ 1113.750110] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-9 ,Falling back to legacy EQ's
%[ 1113.750363] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-10 ,Falling back to legacy EQ's
%[ 1113.750647] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-11 ,Falling back to legacy EQ's
%[ 1113.750893] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-12 ,Falling back to legacy EQ's
%[ 1113.751201] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-13 ,Falling back to legacy EQ's
%[ 1113.751470] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-14 ,Falling back to legacy EQ's
%[ 1113.751728] mlx4_en 0000:81:00.0: Failed Assigning an EQ to enp129s0d1-15 ,Falling back to legacy EQ's


\section{Settings influence}
Enabled SELinux:
Enabled rp\_filter:

IPv4 BGP table:

%Enabled netfilter with 1000 rules:

%NAT:

\section{IPv4 BGP}
\begin{lstlisting}
Basic info: size of leaf: 40 bytes, size of tnode: 40 bytes.
Main:
	Aver depth:     2.43
	Max depth:      8
	Leaves:         503308
	Prefixes:       538739
	Internal nodes: 114429
	  1: 58727  2: 26171  3: 14805  4: 7315  5: 4240  6: 2103  7: 1065  8: 2  17: 1
	Pointers: 995794
Null ptrs: 378058
Total size: 61373  kB

Counters:
---------
gets = 14129134
backtracks = 1913823
semantic match passed = 15973885
semantic match miss = 0
null node hit= 1360956
skipped node resize = 0

Local:
	Aver depth:     3.08
	Max depth:      4
	Leaves:         12
	Prefixes:       13
	Internal nodes: 7
	  1: 6  3: 1
	Pointers: 20
Null ptrs: 2
Total size: 2  kB

Counters:
---------
gets = 13959019
backtracks = 15201204
semantic match passed = 103193
semantic match miss = 0
null node hit= 8238092
skipped node resize = 0
\end{lstlisting}
